<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#047857">
    <meta name="description" content="Aplikasi Dzikir & Doa Qurani Premium">
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dzikir App">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/dawamie87/Zikir-dan-Doa-Qur-ani/main/Dzikir.png">

    <link rel="manifest" id="my-manifest">
    <title>Dzikir & Doa Qurani</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;500;600;700&family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @font-face {
            font-family: 'LPMQ Isep Misbah';
            src: url('https://raw.githubusercontent.com/dawamie87/Zikir-dan-Doa-Qur-ani/main/LPMQ_IsepMisbah.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        :root {
            --font-ui: 'Inter', system-ui, -apple-system, sans-serif;
            --font-arabic: 'LPMQ Isep Misbah', 'Scheherazade New', 'Amiri', serif;
            --primary: #047857; 
            --bg-light: #f8fafc;
            --scale-arabic: 1;
            --scale-translation: 1;
            --base-arabic-mobile: 2.0rem;
            --base-arabic-desktop: 3.0rem;
            --base-translation: 0.875rem; 
        }

        body {
            font-family: var(--font-ui);
            background-color: #f1f5f9; 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            /* Prevent text selection */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        @media (min-width: 768px) {
            body {
                background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23cbd5e1' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 100vh;
                padding: 20px;
            }
        }

        .font-arabic-dynamic {
            font-family: var(--font-arabic);
            line-height: 2.2; 
            font-feature-settings: "kern" 1, "liga" 1, "calt" 1, "dlig" 1, "mkmk" 1, "ccmp" 1;
            font-variant-ligatures: common-ligatures contextual;
            text-rendering: optimizeLegibility;
            font-weight: normal !important;
            font-size: calc(var(--base-arabic-mobile) * var(--scale-arabic));
            transition: font-size 0.2s ease;
            padding-top: 0.1em;
            padding-bottom: 0.1em;
            display: inline-block;
        }

        .font-translation-dynamic {
            font-size: calc(var(--base-translation) * var(--scale-translation));
            line-height: 1.6;
            transition: font-size 0.2s ease;
        }

        @media (min-width: 768px) {
            .font-arabic-dynamic {
                font-size: calc(var(--base-arabic-desktop) * var(--scale-arabic));
            }
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }

        .islamic-pattern {
            background-color: #ffffff;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23047857' fill-opacity='0.04'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        .tasbih-active { animation: pulse-green 0.5s ease-out; }

        @keyframes heart-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        .heart-animate { animation: heart-pop 0.3s ease-out; }

        .modal-transition { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-open { transform: translateY(0) !important; }

        /* Custom style for Quran List */
        .quran-list-item:active { background-color: #ecfdf5; }
        
        /* Audio Player Styles */
        .btn-audio-playing { background-color: #d1fae5; color: #059669; border-color: #10b981; }

        /* Tafsir Text Style */
        .tafsir-content p { margin-bottom: 1rem; text-align: justify; }
        
        /* Allow selection only in specific areas if needed */
        .select-text { -webkit-user-select: text; user-select: text; }

        /* Tab Switcher Styles */
        .tab-btn { position: relative; color: #64748b; transition: all 0.3s; }
        .tab-btn.active { color: #047857; font-weight: 700; }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 20px; height: 3px; background-color: #047857; border-radius: 10px; }
        
        /* Bookmark highlight in ayat detail */
        .ayat-highlighted { animation: highlight-pulse 2s ease-out; background-color: #ecfdf5; border-color: #34d399; }
        @keyframes highlight-pulse { 0% { background-color: #d1fae5; } 100% { background-color: white; } }
    </style>
</head>
<body>

    <main id="app-root" class="w-full h-[100dvh] bg-white shadow-2xl overflow-hidden relative
        md:h-[85vh] md:w-[480px] md:max-w-lg md:rounded-[2.5rem] md:border-8 md:border-white md:ring-1 md:ring-gray-200">
    </main>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-5 py-3 rounded-full text-xs font-medium shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none z-50 flex items-center gap-2 w-max max-w-[90%]">
        <i class="fa-solid fa-circle-notch fa-spin"></i>
        <span id="toast-msg">Memuat data...</span>
    </div>

    <!-- OVERLAY MODAL -->
    <div id="modal-overlay" onclick="closeAllModals()" class="fixed inset-0 bg-black/50 z-40 hidden transition-opacity duration-300 opacity-0"></div>

    <!-- TAFSIR MODAL -->
    <div id="tafsir-modal" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl z-50 h-[80vh] flex flex-col shadow-[0_-10px_40px_rgba(0,0,0,0.1)] transform translate-y-full modal-transition md:max-w-lg md:mx-auto md:rounded-2xl md:bottom-4 md:w-[90%]">
        <div class="flex justify-between items-center p-4 border-b border-gray-100 bg-white rounded-t-2xl shrink-0">
            <div>
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fa-solid fa-book-open-reader text-emerald-600"></i> Tafsir Ayat</h3>
                <p id="tafsir-subtitle" class="text-xs text-slate-500 font-medium">Memuat sumber...</p>
            </div>
            <button onclick="closeAllModals()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div id="tafsir-content-area" class="flex-grow overflow-y-auto p-6 text-slate-700 leading-relaxed text-sm tafsir-content bg-slate-50 select-text">
            <!-- Content will be injected here -->
            <div class="flex flex-col items-center justify-center h-full text-slate-400 gap-2">
                <i class="fa-solid fa-circle-notch fa-spin text-2xl text-emerald-500"></i>
                <span class="text-xs">Mengambil data tafsir...</span>
            </div>
        </div>
    </div>

    <!-- LIST/TOC MODAL -->
    <div id="toc-modal" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl z-50 h-[75vh] flex flex-col shadow-[0_-10px_40px_rgba(0,0,0,0.1)] transform translate-y-full modal-transition md:max-w-lg md:mx-auto md:rounded-2xl md:bottom-4 md:w-[90%]">
        <div class="flex justify-between items-center p-4 border-b border-gray-100 bg-white rounded-t-2xl shrink-0">
            <h3 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-list-ul text-emerald-600 mr-2"></i> Daftar Isi</h3>
            <button onclick="closeAllModals()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div id="toc-content-area" class="flex-grow overflow-y-auto p-4 bg-slate-50 space-y-2">
            <!-- List items injected here -->
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl z-50 p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.1)] transform translate-y-full modal-transition md:max-w-lg md:mx-auto md:rounded-2xl md:bottom-4 md:w-[90%]">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-sliders mr-2 text-emerald-600"></i>Tampilan</h3>
            <button onclick="closeAllModals()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div class="mb-6">
            <div class="flex justify-between mb-2">
                <label class="text-sm font-medium text-slate-600">Ukuran Huruf Arab</label>
                <span class="text-xs text-emerald-600 font-bold" id="lbl-arabic-size">100%</span>
            </div>
            <input type="range" min="0.8" max="2.0" step="0.1" value="1" id="input-arabic-size" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-emerald-600">
        </div>
        <div class="mb-4">
            <div class="flex justify-between mb-2">
                <label class="text-sm font-medium text-slate-600">Ukuran Terjemahan</label>
                <span class="text-xs text-emerald-600 font-bold" id="lbl-translation-size">100%</span>
            </div>
            <input type="range" min="0.8" max="1.8" step="0.1" value="1" id="input-translation-size" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-emerald-600">
        </div>
        <button onclick="resetSettings()" class="text-xs text-slate-400 underline hover:text-emerald-600 w-full text-center mt-4">Reset ke Default</button>
    </div>

    <!-- SUPPORT MODAL -->
    <div id="support-modal" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl z-50 p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.1)] transform translate-y-full modal-transition md:max-w-lg md:mx-auto md:rounded-2xl md:bottom-4 md:w-[90%] text-center">
        <div class="w-16 h-16 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-4 border border-emerald-100">
            <i class="fa-solid fa-mug-hot"></i>
        </div>
        <h3 class="text-xl font-bold text-slate-800 mb-2">Support Pengembangan</h3>
        <p class="text-sm text-slate-500 mb-6 leading-relaxed px-4">Jika aplikasi ini bermanfaat bagi Anda, dukung pengembangannya melalui infaq/donasi ke:</p>
        
        <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4 mb-6">
            <p class="text-xs text-slate-400 uppercase font-bold tracking-widest mb-1">Bank Central Asia (BCA)</p>
            <div class="flex items-center justify-center gap-3 mb-1">
                <span class="text-2xl font-mono font-bold text-slate-800">676030548</span>
                <button onclick="copyToClipboard('676030548')" class="text-emerald-600 text-sm active:scale-90 transition-transform"><i class="fa-solid fa-copy"></i></button>
            </div>
            <p class="text-sm font-medium text-slate-600">an. Ahmad Dawami</p>
        </div>

        <button onclick="closeAllModals()" class="w-full py-3.5 bg-emerald-600 text-white rounded-xl font-bold shadow-lg shadow-emerald-200 active:scale-95 transition-all">Tutup</button>
    </div>

    <script>
        // Security: Prevent Right Click and Developer Tools
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });
        
        document.onkeydown = function(e) {
            if(e.keyCode == 123) { return false; } // F12
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { return false; } // Ctrl+Shift+I
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { return false; } // Ctrl+Shift+C
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) { return false; } // Ctrl+Shift+J
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { return false; } // Ctrl+U
        };

        const manifestData = {
            "name": "Dzikir & Doa Qurani",
            "short_name": "DzikirApp",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#047857",
            "icons": [{ "src": "https://raw.githubusercontent.com/dawamie87/Zikir-dan-Doa-Qur-ani/main/Dzikir.png", "sizes": "512x512", "type": "image/png" }]
        };
        document.getElementById('my-manifest').setAttribute('href', URL.createObjectURL(new Blob([JSON.stringify(manifestData)], {type: 'application/json'})));

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; if(document.getElementById('btn-install-app')) document.getElementById('btn-install-app').classList.remove('hidden'); });
        async function installPWA() { if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt = null; document.getElementById('btn-install-app').classList.add('hidden'); } else alert("Gunakan menu browser untuk Install."); }

        // ==========================================
        // 1. FONT SETTINGS
        // ==========================================
        function initSettings() {
            const savedArabic = localStorage.getItem('scale-arabic') || 1;
            const savedTranslation = localStorage.getItem('scale-translation') || 1;
            updateFontScale('arabic', savedArabic, false);
            updateFontScale('translation', savedTranslation, false);
            document.getElementById('input-arabic-size').addEventListener('input', (e) => updateFontScale('arabic', e.target.value));
            document.getElementById('input-translation-size').addEventListener('input', (e) => updateFontScale('translation', e.target.value));
        }
        function updateFontScale(type, value, save = true) {
            document.documentElement.style.setProperty(`--scale-${type}`, value);
            document.getElementById(`input-${type}-size`).value = value;
            document.getElementById(`lbl-${type}-size`).innerText = Math.round(value * 100) + "%";
            if(save) localStorage.setItem(`scale-${type}`, value);
        }
        
        function openModal(id) {
            const overlay = document.getElementById('modal-overlay');
            const modal = document.getElementById(id);
            overlay.classList.remove('hidden');
            setTimeout(() => overlay.classList.remove('opacity-0'), 10);
            modal.classList.add('modal-open');
        }
        function closeAllModals() {
            const overlay = document.getElementById('modal-overlay');
            const modals = document.querySelectorAll('.modal-transition');
            overlay.classList.add('opacity-0');
            modals.forEach(m => m.classList.remove('modal-open'));
            setTimeout(() => overlay.classList.add('hidden'), 300);
        }
        function resetSettings() { updateFontScale('arabic', 1); updateFontScale('translation', 1); }

        function copyToClipboard(text) {
            const temp = document.createElement('input');
            temp.value = text;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            showToast("Berhasil disalin");
        }

        // ==========================================
        // 2. LOGIC PRAYER TIMES
        // ==========================================
        let PrayerTimes = null; let UserLocation = "Jakarta";
        async function fetchPrayerTimes() {
            const cached = localStorage.getItem('prayer_times_data'); const today = new Date().toISOString().split('T')[0];
            if(cached){ const d=JSON.parse(cached); if(d.date===today){ PrayerTimes=d.timings; UserLocation=d.location; updatePrayerUI(); return; }}
            let lat = -6.2088, lng = 106.8456;
            if (navigator.geolocation) navigator.geolocation.getCurrentPosition(async (p)=>{lat=p.coords.latitude;lng=p.coords.longitude; await getTimes(lat,lng,today,"Lokasi Anda");}, async()=>{await getTimes(lat,lng,today,"Jakarta");}); else await getTimes(lat,lng,today,"Jakarta");
        }
        async function getTimes(lat, lng, date, loc) { try { const r=await fetch(`https://api.aladhan.com/v1/timings/${date}?latitude=${lat}&longitude=${lng}&method=20`); const j=await r.json(); if(j.code===200){PrayerTimes=j.data.timings; UserLocation=loc; localStorage.setItem('prayer_times_data', JSON.stringify({date:date,timings:PrayerTimes,location:loc})); updatePrayerUI();} } catch(e){} }
        function updatePrayerUI() {
            if(!document.getElementById('prayer-schedule-card') || !PrayerTimes) return;
            document.getElementById('location-name').innerText = UserLocation;
            const next = getNextPrayer(PrayerTimes);
            document.getElementById('next-prayer-name').innerText = next.name; document.getElementById('next-prayer-time').innerText = next.time;
            const list = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'], map={'Fajr':'Subuh','Dhuhr':'Dzuhur','Asr':'Ashar','Maghrib':'Maghrib','Isha':'Isya'};
            let h=''; list.forEach(k=>{ const s=k===next.raw?"bg-emerald-500/30 text-white font-bold border border-white/20":"text-emerald-100/80"; h+=`<div class="flex flex-col items-center py-1.5 rounded ${s}"><span class="text-[9px] uppercase opacity-70 mb-0.5 font-medium">${map[k]}</span><span class="text-xs font-semibold">${PrayerTimes[k]}</span></div>`; });
            document.getElementById('prayer-grid').innerHTML = h;
        }
        function getNextPrayer(t) {
            const n=new Date(), c=n.getHours()*60+n.getMinutes(), l=['Fajr','Dhuhr','Asr','Maghrib','Isha'], m={'Fajr':'Subuh','Dhuhr':'Dzuhur','Asr':'Ashar','Maghrib':'Maghrib','Isha':'Isya'};
            for(let k of l){ const[h,mm]=t[k].split(':'); if((parseInt(h)*60+parseInt(mm))>c) return {name:m[k], time:t[k], raw:k}; }
            return {name:'Subuh', time:t['Fajr'], raw:'Fajr'};
        }

        // ==========================================
        // 3. LOGIC BOOKMARK & TASBIH (GENERAL)
        // ==========================================
        const BOOKMARK_KEY = "dzikir_app_bookmarks";
        const QURAN_BOOKMARK_KEY = "quran_ayat_bookmarks"; // NEW Key for Quran Bookmarks

        function getBookmarks() { return JSON.parse(localStorage.getItem(BOOKMARK_KEY) || "[]"); }
        function getQuranBookmarks() { return JSON.parse(localStorage.getItem(QURAN_BOOKMARK_KEY) || "[]"); }

        function isBookmarked(item) {
            const bookmarks = getBookmarks();
            return bookmarks.some(b => b.title === item.title && b.arabic.substring(0, 20) === item.arabic.substring(0, 20));
        }
        
        // Quran Bookmark Logic
        function isQuranBookmarked(surahNo, ayatNo) {
            const marks = getQuranBookmarks();
            return marks.some(b => b.surahNo === surahNo && b.ayatNo === ayatNo);
        }

        function toggleQuranBookmark(surahNo, surahName, ayatNo) {
            let marks = getQuranBookmarks();
            const existingIndex = marks.findIndex(b => b.surahNo === surahNo && b.ayatNo === ayatNo);
            
            const btnIcon = document.querySelector(`#btn-bookmark-${ayatNo} i`);
            const btn = document.getElementById(`btn-bookmark-${ayatNo}`);

            if (existingIndex !== -1) {
                // Remove
                marks.splice(existingIndex, 1);
                showToast("Bookmark dihapus");
                if(btnIcon) { btnIcon.classList.remove('fa-solid'); btnIcon.classList.add('fa-regular'); }
                if(btn) { btn.classList.replace('text-emerald-600', 'text-slate-400'); btn.classList.replace('bg-emerald-50', 'bg-slate-50'); }
            } else {
                // Add
                marks.unshift({ surahNo, surahName, ayatNo, date: new Date().toISOString() });
                showToast("Ayat ditandai");
                if(btnIcon) { btnIcon.classList.remove('fa-regular'); btnIcon.classList.add('fa-solid'); }
                if(btn) { btn.classList.replace('text-slate-400', 'text-emerald-600'); btn.classList.replace('bg-slate-50', 'bg-emerald-50'); }
            }
            localStorage.setItem(QURAN_BOOKMARK_KEY, JSON.stringify(marks));
            
            // If we are in Bookmark tab, refresh the list
            if(AppState.currentView === 'quranList' && AppState.activeQuranTab === 'bookmark') {
                renderBookmarkTab();
            }
        }

        function toggleBookmark(index) {
            const item = AppState.data[index];
            let bookmarks = getBookmarks();
            if (isBookmarked(item)) {
                bookmarks = bookmarks.filter(b => !(b.title === item.title && b.arabic.substring(0, 20) === item.arabic.substring(0, 20)));
                showToast("Dihapus dari Favorit");
            } else {
                bookmarks.push(item);
                showToast("Disimpan ke Favorit");
            }
            localStorage.setItem(BOOKMARK_KEY, JSON.stringify(bookmarks));
            const btn = document.getElementById(`btn-heart-${index}`);
            if(btn) {
                const isFav = isBookmarked(item);
                btn.innerHTML = isFav ? '<i class="fa-solid fa-heart"></i>' : '<i class="fa-regular fa-heart"></i>';
                btn.classList.toggle('text-rose-500', isFav); btn.classList.toggle('text-slate-300', !isFav);
                btn.classList.add('heart-animate'); setTimeout(() => btn.classList.remove('heart-animate'), 300);
            }
        }
        function handleTasbihTap(btn, targetCount) {
            event.stopPropagation();
            const countDisplay = btn.querySelector('.tasbih-counter');
            let currentCount = parseInt(btn.dataset.current || 0);
            if (currentCount < targetCount) {
                currentCount++; btn.dataset.current = currentCount; countDisplay.innerText = currentCount;
                btn.classList.add('tasbih-active'); setTimeout(() => btn.classList.remove('tasbih-active'), 200);
                if (navigator.vibrate) navigator.vibrate(30);
                if (currentCount >= targetCount) {
                    btn.classList.remove('bg-emerald-50', 'text-emerald-700', 'border-emerald-200');
                    btn.classList.add('bg-emerald-600', 'text-white', 'border-emerald-600');
                    btn.innerHTML = `<i class="fa-solid fa-check mr-2"></i> Selesai (${targetCount})`;
                    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                }
            } else {
                if(confirm("Ulangi hitungan?")) {
                    btn.dataset.current = 0; btn.classList.remove('bg-emerald-600', 'text-white', 'border-emerald-600');
                    btn.classList.add('bg-emerald-50', 'text-emerald-700', 'border-emerald-200');
                    btn.innerHTML = `<i class="fa-solid fa-fingerprint mr-2"></i> <span class="tasbih-counter">0</span> / ${targetCount}`;
                }
            }
        }

        // ==========================================
        // 4. DATABASE & FETCH
        // ==========================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw8J1hsT-Nb9eBOwDWkPG9Iff6d6Vb9lThA0RjIioCorPRpD3A5oYQ8fIjgXcjQ8J8fAw/exec"; 
        const CACHE_KEY = "dzikir_app_data_v1";
        let DB = { dzikirPagi: [], dzikirPetang: [], doaHarian: [], dzikirShalat: [], doaQurani: [], bacaanShalat: [] };

        function smartNormalize(data) {
            const normalized = {};
            const keyMap = { 'id': 'id', 'judul': 'title', 'nama': 'title', 'arab': 'arabic', 'teks': 'arabic', 'latin': 'latin', 'terjemah': 'translation', 'faedah': 'faedah', 'jumlah': 'count', 'sumber': 'source', 'isi': 'content', 'contoh': 'example' };
            Object.keys(data).forEach(k => {
                normalized[k] = data[k].map(i => {
                    const n = {}; Object.keys(i).forEach(rk => n[keyMap[rk.toLowerCase().trim()] || rk.toLowerCase().trim()] = i[rk]); return n;
                }).filter(i => (i.arabic && i.arabic.toString().length > 3) || (i.title && i.title.toString().length > 2));
            });
            return normalized;
        }

        function showToast(msg, isError=false) {
            const t = document.getElementById('toast'), tm = document.getElementById('toast-msg'), i = t.querySelector('i');
            if(t && tm) { tm.innerText = msg; t.classList.remove('opacity-0'); 
            if(isError) { t.classList.replace('bg-slate-800','bg-red-600'); i.className="fa-solid fa-triangle-exclamation"; } 
            else { t.classList.replace('bg-slate-800','bg-emerald-600'); i.className= msg.includes("Memuat") ? "fa-solid fa-circle-notch fa-spin" : "fa-solid fa-check"; if(!msg.includes("Memuat")) setTimeout(()=>t.classList.add('opacity-0'),3000); } }
        }

        async function fetchData() {
            const cached = localStorage.getItem(CACHE_KEY);
            if(cached) { try { DB = JSON.parse(cached); if(AppState.currentView !== 'home') render(AppState.currentView, AppState.currentParams); } catch(e){} }
            if(!SCRIPT_URL) return;
            try {
                const res = await fetch(SCRIPT_URL + "?t=" + new Date().getTime());
                if(res.ok) { const json = await res.json(); DB = smartNormalize(json); localStorage.setItem(CACHE_KEY, JSON.stringify(DB)); if(AppState.currentView !== 'home') render(AppState.currentView, AppState.currentParams); }
            } catch(e) {}
        }

        // ==========================================
        // 5. UI RENDERERS
        // ==========================================
        const AppState = { 
            currentView: 'home', 
            data: null, 
            currentIndex: 0, 
            isRTL: false, 
            currentParams: null, 
            quranListCache: null, 
            currentSurahData: null, 
            tafsirCache: {},
            activeQuranTab: 'surah' // New state for tabs
        };
        const root = document.getElementById('app-root');
        
        // Global Audio Variables
        let activeAudio = null;
        let activeAudioBtn = null;

        function navigateTo(view, params = null) {
            // Stop audio if navigating away
            if(activeAudio) { activeAudio.pause(); activeAudio = null; }
            
            AppState.currentParams = params; root.style.opacity = '0.7';
            setTimeout(() => { AppState.currentView = view; AppState.currentIndex = 0; render(view, params); root.style.opacity = '1'; root.scrollTop = 0; }, 100);
        }

        function render(view, params) {
            root.innerHTML = '';
            switch(view) {
                case 'home': renderHome(); break;
                case 'slider': renderSliderView(params.type, params.title, params.rtl, params.isCombined); break;
                case 'quranList': renderQuranList(); break;
                case 'quranDetail': renderQuranDetail(params.surahNo, params.surahName, params.highlightAyat); break;
                default: renderHome();
            }
        }

        function renderHome() {
            const h = new Date().getHours();
            const greet = h>=10&&h<15?"Selamat Siang":h>=15&&h<18?"Selamat Sore":h>=18?"Selamat Malam":"Selamat Pagi";
            const quote = ["Ingatlah, hanya dengan mengingat Allah hati menjadi tenteram. (QS. Ar-Ra‘d: 28)", "Dan sungguh, mengingat Allah itu lebih besar (keutamaannya). (QS. Al-‘Ankabut: 45)", "Perumpamaan orang yang berzikir kepada Rabb-nya dan yang tidak berzikir adalah seperti orang hidup dan orang mati. (HR. Bukhari)"][Math.floor(Math.random()*3)];
            
            root.innerHTML = `
                <div class="h-full flex flex-col islamic-pattern relative animate-fade-in bg-white">
                    <div class="pt-6 px-6 flex justify-between items-start z-10 shrink-0 mb-2">
                        <div>
                            <p class="text-emerald-600 font-medium text-[10px] tracking-[0.2em] uppercase mb-1 opacity-90">Assalamualaikum</p>
                            <h1 class="text-2xl font-bold text-slate-800 leading-tight">${greet}</h1>
                        </div>
                        <div class="flex gap-2">
                            <button id="btn-install-app" onclick="installPWA()" class="hidden bg-emerald-50 text-emerald-700 px-3 py-1.5 rounded-full text-[10px] font-bold shadow-sm hover:bg-emerald-100 transition-colors flex items-center gap-1 border border-emerald-100"><i class="fa-solid fa-download"></i> Install</button>
                            <button onclick="navigateTo('slider', {type:'favorites', title:'Favorit Saya', rtl:true})" class="w-9 h-9 rounded-full bg-rose-50 text-rose-500 hover:bg-rose-100 transition-colors flex items-center justify-center border border-rose-100 shadow-sm"><i class="fa-solid fa-heart"></i></button>
                            <button onclick="openModal('support-modal')" class="w-9 h-9 rounded-full bg-amber-50 flex items-center justify-center text-amber-600 hover:bg-amber-100 transition-colors shadow-sm border border-amber-100"><i class="fa-solid fa-mug-hot"></i></button>
                        </div>
                    </div>

                    <div id="prayer-schedule-card" class="mx-6 mb-4 p-4 bg-gradient-to-br from-emerald-600 to-emerald-800 rounded-2xl text-white shadow-xl shadow-emerald-200/50 relative overflow-hidden shrink-0 z-10">
                        <div class="absolute -bottom-4 -right-2 opacity-10 rotate-12"><i class="fa-solid fa-mosque text-8xl"></i></div>
                        <div class="relative z-10 flex justify-between items-center mb-3">
                            <div><div class="flex items-center text-emerald-100 text-[11px] font-medium mb-1"><i class="fa-solid fa-location-dot mr-1.5"></i> <span id="location-name">Memuat...</span></div><div class="text-xl font-bold tracking-tight leading-none" id="next-prayer-name">...</div></div>
                            <div class="text-right"><div class="text-[10px] text-emerald-100 uppercase tracking-wider mb-0.5">Menuju Shalat</div><div class="text-3xl font-bold font-mono leading-none tracking-tight" id="next-prayer-time">--:--</div></div>
                        </div>
                        <div id="prayer-grid" class="relative z-10 grid grid-cols-5 gap-2 pt-3 border-t border-white/10"><div class="text-center text-emerald-100 text-[10px]">...</div></div>
                    </div>

                    <div class="flex-grow overflow-y-auto hide-scrollbar px-6 pb-4 flex flex-col justify-between">
                        <div><div class="grid grid-cols-2 gap-4">
                                ${MenuCard("Dzikir Pagi & Petang", "fa-sun", "slider", {type:'dzikirPagi', title:'Dzikir Pagi', rtl:true, isCombined: true})}
                                ${MenuCard("Al-Qur'an", "fa-quran", "quranList", {})}
                                ${MenuCard("Doa Qurani", "fa-book-quran", "slider", {type:'doaQurani', title:'Doa-Doa Qurani', rtl:true})}
                                ${MenuCard("Doa Harian", "fa-hands-praying", "slider", {type:'doaHarian', title:'Doa Harian', rtl:true})}
                                ${MenuCard("Dzikir Shalat", "fa-mosque", "slider", {type:'dzikirShalat', title:'Dzikir Setelah Shalat', rtl:true})} 
                                ${MenuCard("Bacaan Shalat", "fa-book-open", "slider", {type:'bacaanShalat', title:'Bacaan Shalat', rtl:true})}
                        </div></div>
                        <div class="mt-auto pt-6 pb-2">
                             <div class="p-3 bg-emerald-50/60 rounded-xl border border-emerald-100 text-center mx-1 shadow-sm mb-4"><p class="text-xs font-medium text-emerald-800 leading-relaxed italic">"${quote}"</p></div>
                            <p class="text-[10px] text-gray-400 font-semibold tracking-wide uppercase text-center">© Ahmad Dawami</p>
                        </div>
                    </div>
                </div>`;
            if(window.deferredPrompt) document.getElementById('btn-install-app').classList.remove('hidden');
            setTimeout(fetchPrayerTimes, 100);
        }

        function MenuCard(t, i, v, p) {
            return `<button onclick="navigateTo('${v}', ${JSON.stringify(p).replace(/"/g, "&quot;")})" class="group relative bg-white p-3 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 transition-all duration-300 hover:shadow-lg hover:border-emerald-300 hover:-translate-y-1 h-32 w-full">
                <div class="w-12 h-12 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center text-xl group-hover:bg-emerald-600 group-hover:text-white transition-colors duration-300 shadow-sm ring-1 ring-emerald-100"><i class="fa-solid ${i}"></i></div>
                <span class="text-sm font-bold text-slate-700 leading-tight text-center px-1">${t}</span>
            </button>`;
        }

        // ==========================================
        // 6. QURAN API INTEGRATION (Refined with Tabs & Bookmark)
        // ==========================================
        
        function switchQuranTab(tabName) {
            AppState.activeQuranTab = tabName;
            
            // Update Tab UI
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-btn-${tabName}`).classList.add('active');
            
            // Render Content
            if(tabName === 'surah') {
                document.getElementById('quran-search-container').classList.remove('hidden');
                if (AppState.quranListCache) renderSurahTab(AppState.quranListCache);
                else renderQuranList(); // Fetch again
            } else if (tabName === 'juz') {
                document.getElementById('quran-search-container').classList.add('hidden');
                renderJuzTab();
            } else if (tabName === 'bookmark') {
                document.getElementById('quran-search-container').classList.add('hidden');
                renderBookmarkTab();
            }
        }

        async function renderQuranList() {
            root.innerHTML = `
                <div class="h-full flex flex-col bg-white animate-fade-in relative">
                    <div class="flex items-center justify-between px-4 py-4 z-30 bg-white/95 backdrop-blur-sm sticky top-0 h-16 shadow-sm border-b border-gray-100">
                        <button onclick="navigateTo('home')" class="w-10 h-10 flex items-center justify-center text-slate-500 hover:bg-slate-100 rounded-full transition-colors"><i class="fa-solid fa-arrow-left"></i></button>
                        <h2 class="text-lg font-bold text-slate-800 tracking-tight">Al-Qur'an</h2>
                        <div class="w-10"></div>
                    </div>
                    
                    <!-- Search Bar -->
                    <div id="quran-search-container" class="px-4 pt-4 pb-2 bg-white sticky top-16 z-20">
                        <div class="relative">
                            <i class="fa-solid fa-magnifying-glass absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                            <input type="text" id="quran-search-input" oninput="handleSurahSearch(this.value)" placeholder="Cari surah..." class="w-full bg-slate-50 border border-slate-200 rounded-xl pl-10 pr-4 py-2.5 text-sm focus:outline-none focus:ring-1 focus:ring-emerald-500 focus:border-emerald-500 transition-all">
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="flex border-b border-gray-100 sticky top-[7.5rem] bg-white z-20 px-2">
                        <button id="tab-btn-surah" onclick="switchQuranTab('surah')" class="tab-btn flex-1 py-3 text-sm font-medium text-center active"><i class="fa-solid fa-book-quran mr-1.5"></i> Surah</button>
                        <button id="tab-btn-juz" onclick="switchQuranTab('juz')" class="tab-btn flex-1 py-3 text-sm font-medium text-center"><i class="fa-solid fa-layer-group mr-1.5"></i> Juz</button>
                        <button id="tab-btn-bookmark" onclick="switchQuranTab('bookmark')" class="tab-btn flex-1 py-3 text-sm font-medium text-center"><i class="fa-solid fa-bookmark mr-1.5"></i> Bookmark</button>
                    </div>

                    <div id="quran-container" class="flex-grow overflow-y-auto hide-scrollbar p-4 space-y-2 pt-2">
                        <div class="flex flex-col items-center justify-center h-64 text-slate-400 gap-2">
                            <i class="fa-solid fa-circle-notch fa-spin text-3xl text-emerald-500"></i>
                            <span class="text-sm">Memuat Daftar Surah...</span>
                        </div>
                    </div>
                </div>`;
            
            if (AppState.activeQuranTab !== 'surah') {
                switchQuranTab(AppState.activeQuranTab);
                return;
            }

            if (AppState.quranListCache) {
                 renderSurahTab(AppState.quranListCache);
                 return;
            }

            try {
                const response = await fetch('https://equran.id/api/v2/surat');
                const result = await response.json();
                if(result.code === 200) {
                    AppState.quranListCache = result.data; // Cache data
                    renderSurahTab(result.data);
                } else { throw new Error("Gagal memuat"); }
            } catch(e) {
                document.getElementById('quran-container').innerHTML = `<div class="text-center p-6 text-red-500">Gagal memuat data Al-Qur'an. Periksa koneksi internet Anda.<br><button onclick="renderQuranList()" class="mt-4 px-4 py-2 bg-emerald-600 text-white rounded-full text-sm">Coba Lagi</button></div>`;
            }
        }

        function handleSurahSearch(keyword) {
            if (!AppState.quranListCache || AppState.activeQuranTab !== 'surah') return;
            const k = keyword.toLowerCase();
            const filtered = AppState.quranListCache.filter(s => s.namaLatin.toLowerCase().includes(k) || s.arti.toLowerCase().includes(k));
            renderSurahTab(filtered);
        }

        function renderSurahTab(data) {
             const container = document.getElementById('quran-container');
             if(data.length === 0) {
                 container.innerHTML = `<div class="text-center py-10 text-slate-400 text-sm">Surah tidak ditemukan</div>`;
                 return;
             }
             const html = data.map(surat => {
                const safeName = surat.namaLatin.replace(/'/g, "\\'");
                return `
                <div onclick="navigateTo('quranDetail', {surahNo: ${surat.nomor}, surahName: '${safeName}'})" class="quran-list-item flex items-center p-3 rounded-xl border border-gray-100 bg-white shadow-sm cursor-pointer transition-colors">
                    <div class="w-10 h-10 rounded-full bg-emerald-50 text-emerald-700 flex items-center justify-center font-bold text-sm border border-emerald-100 mr-4 shrink-0">${surat.nomor}</div>
                    <div class="flex-grow">
                        <h4 class="font-bold text-slate-800 text-base">${surat.namaLatin}</h4>
                        <p class="text-[10px] text-slate-500 uppercase tracking-wide font-medium">${surat.arti} • ${surat.jumlahAyat} Ayat</p>
                    </div>
                    <div class="text-right">
                        <span class="font-arabic-dynamic text-emerald-800 text-xl font-normal leading-none" style="--scale-arabic: 1.2;">${surat.nama}</span>
                    </div>
                </div>`;
            }).join('');
            container.innerHTML = html;
        }

        function renderJuzTab() {
            const container = document.getElementById('quran-container');
            let html = '<div class="grid grid-cols-3 gap-3">';
            for (let i = 1; i <= 30; i++) {
                html += `
                <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex flex-col items-center justify-center cursor-pointer hover:bg-emerald-50 transition-colors" onclick="alert('Fitur detail per Juz akan segera hadir. Silakan gunakan tab Surah untuk saat ini.')">
                    <span class="text-emerald-600 font-bold text-lg mb-1">${i}</span>
                    <span class="text-[10px] uppercase text-slate-500 font-medium">Juz</span>
                </div>`;
            }
            html += '</div>';
            container.innerHTML = html;
        }

        function renderBookmarkTab() {
            const bookmarks = getQuranBookmarks();
            const container = document.getElementById('quran-container');
            
            if(bookmarks.length === 0) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-slate-400 gap-3">
                    <i class="fa-regular fa-bookmark text-4xl text-slate-300"></i>
                    <span class="text-sm text-center">Belum ada ayat yang ditandai.<br>Tekan ikon bookmark pada ayat untuk menyimpan.</span>
                </div>`;
                return;
            }

            // Sort by most recent
            bookmarks.sort((a, b) => new Date(b.date) - new Date(a.date));

            const html = bookmarks.map(b => {
                const safeName = b.surahName.replace(/'/g, "\\'");
                const date = new Date(b.date).toLocaleDateString('id-ID', {day: 'numeric', month: 'short'});
                return `
                <div onclick="navigateTo('quranDetail', {surahNo: ${b.surahNo}, surahName: '${safeName}', highlightAyat: ${b.ayatNo}})" class="flex items-center p-4 rounded-xl border border-gray-100 bg-white shadow-sm cursor-pointer transition-colors group relative overflow-hidden mb-2">
                    <div class="absolute top-0 left-0 w-1 h-full bg-emerald-500"></div>
                    <div class="flex-grow pl-3">
                        <div class="flex justify-between items-center mb-1">
                            <h4 class="font-bold text-slate-800 text-sm">QS. ${b.surahName}</h4>
                            <span class="text-[10px] text-slate-400">${date}</span>
                        </div>
                        <p class="text-xs text-slate-500">Ayat ke-${b.ayatNo}</p>
                    </div>
                    <div class="text-emerald-600 bg-emerald-50 w-8 h-8 rounded-full flex items-center justify-center text-xs">
                        <i class="fa-solid fa-chevron-right"></i>
                    </div>
                </div>`;
            }).join('');
            container.innerHTML = html;
        }

        async function renderQuranDetail(surahNo, surahName, highlightAyat = null) {
            root.innerHTML = `
                <div class="h-full flex flex-col bg-white animate-fade-in relative">
                    <div class="flex items-center justify-between px-4 py-4 border-b border-gray-100 z-30 bg-white/95 backdrop-blur-sm sticky top-0 h-16 shadow-sm">
                        <button onclick="navigateTo('quranList')" class="w-10 h-10 flex items-center justify-center text-slate-500 hover:bg-slate-100 rounded-full transition-colors"><i class="fa-solid fa-arrow-left"></i></button>
                        <h2 class="text-lg font-bold text-slate-800 tracking-tight">${surahName}</h2>
                        <button onclick="openModal('settings-modal')" class="w-10 h-10 flex items-center justify-center text-emerald-600 hover:bg-emerald-50 rounded-full transition-colors"><i class="fa-solid fa-sliders"></i></button>
                    </div>
                    <div id="ayat-container" class="flex-grow overflow-y-auto hide-scrollbar bg-slate-50">
                        <div class="flex flex-col items-center justify-center h-64 text-slate-400 gap-2">
                            <i class="fa-solid fa-circle-notch fa-spin text-3xl text-emerald-500"></i>
                            <span class="text-sm">Memuat Ayat...</span>
                        </div>
                    </div>
                </div>`;

            try {
                const response = await fetch(`https://equran.id/api/v2/surat/${surahNo}`);
                const result = await response.json();
                if(result.code === 200) {
                    const data = result.data;
                    AppState.currentSurahData = data; 

                    let html = `<div class="p-4 space-y-4 pb-20">`;
                    
                    if(surahNo !== 9) {
                        html += `<div class="text-center py-6 mb-2"><span class="font-arabic-dynamic text-2xl text-emerald-800" style="font-family: var(--font-arabic);">بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ</span></div>`;
                    }

                    html += data.ayat.map((ayat, index) => {
                        const isMarked = isQuranBookmarked(surahNo, ayat.nomorAyat);
                        const highlightClass = (highlightAyat && highlightAyat == ayat.nomorAyat) ? 'ayat-highlighted ring-2 ring-emerald-400 ring-offset-2' : '';
                        
                        return `
                        <div id="ayat-${ayat.nomorAyat}" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden group transition-all duration-500 ${highlightClass}">
                            <div class="absolute top-0 left-0 bg-emerald-50 text-emerald-700 px-3 py-1 rounded-br-xl text-xs font-bold border-r border-b border-emerald-100">${ayat.nomorAyat}</div>
                            
                            <!-- Ayat Content -->
                            <div class="mt-6 mb-4 w-full text-right" dir="rtl">
                                <p class="font-arabic-dynamic text-slate-800 leading-[2.4] select-text block mb-2">${ayat.teksArab}</p>
                            </div>
                            <div class="text-left space-y-2 mb-4">
                                <p class="text-emerald-700 text-sm italic opacity-80 leading-relaxed hidden">${ayat.teksLatin}</p>
                                <p class="font-translation-dynamic text-slate-600 leading-relaxed">${ayat.teksIndonesia}</p>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex items-center gap-2 pt-3 border-t border-slate-50">
                                <button id="btn-audio-${index}" onclick="handleAyatAction('play', ${index})" class="w-8 h-8 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center text-xs hover:bg-emerald-100 transition-colors border border-emerald-100">
                                    <i class="fa-solid fa-play ml-0.5"></i>
                                </button>
                                <button id="btn-bookmark-${ayat.nomorAyat}" onclick="toggleQuranBookmark(${surahNo}, '${surahName.replace(/'/g, "\\'")}', ${ayat.nomorAyat})" class="w-8 h-8 rounded-full ${isMarked ? 'bg-emerald-50 text-emerald-600' : 'bg-slate-50 text-slate-400'} flex items-center justify-center text-xs hover:bg-emerald-100 hover:text-emerald-600 transition-colors border border-slate-100">
                                    <i class="${isMarked ? 'fa-solid' : 'fa-regular'} fa-bookmark"></i>
                                </button>
                                <button onclick="handleAyatAction('copy', ${index})" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 flex items-center justify-center text-xs hover:bg-slate-100 hover:text-slate-600 transition-colors border border-slate-100">
                                    <i class="fa-regular fa-copy"></i>
                                </button>
                                <button onclick="handleAyatAction('share', ${index})" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 flex items-center justify-center text-xs hover:bg-slate-100 hover:text-slate-600 transition-colors border border-slate-100">
                                    <i class="fa-solid fa-share-nodes"></i>
                                </button>
                                <div class="flex-grow"></div>
                                <button onclick="openTafsir(${surahNo}, ${ayat.nomorAyat})" class="px-3 py-1.5 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center text-[10px] font-bold hover:bg-slate-200 transition-colors border border-slate-200 gap-1.5">
                                    <i class="fa-solid fa-book-open-reader text-emerald-600"></i> Tafsir
                                </button>
                            </div>
                        </div>
                    `}).join('');
                    html += `</div>`;
                    
                    const ayatContainer = document.getElementById('ayat-container');
                    ayatContainer.innerHTML = html;

                    // Auto scroll to highlighted ayat
                    if (highlightAyat) {
                        setTimeout(() => {
                            const target = document.getElementById(`ayat-${highlightAyat}`);
                            if (target) {
                                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        }, 500);
                    }

                } else { throw new Error("Gagal"); }
            } catch(e) {
                const safeName = surahName.replace(/'/g, "\\'");
                document.getElementById('ayat-container').innerHTML = `<div class="text-center p-6 text-red-500">Gagal memuat ayat. <button onclick="renderQuranDetail(${surahNo}, '${safeName}', ${highlightAyat})" class="underline font-bold mt-2">Coba Lagi</button></div>`;
            }
        }

        // Handle Audio, Copy, Share logic
        function handleAyatAction(action, index) {
            const ayat = AppState.currentSurahData.ayat[index];
            const surahName = AppState.currentSurahData.namaLatin;
            
            if (action === 'play') {
                const btn = document.getElementById(`btn-audio-${index}`);
                // Try to get audio 05 (Misyari) or fallback to any available
                const audioUrl = ayat.audio['05'] || Object.values(ayat.audio)[0]; 

                if (activeAudio && activeAudio.src === audioUrl) {
                    if (activeAudio.paused) {
                        activeAudio.play();
                        btn.innerHTML = '<i class="fa-solid fa-pause"></i>';
                        btn.classList.add('btn-audio-playing');
                    } else {
                        activeAudio.pause();
                        btn.innerHTML = '<i class="fa-solid fa-play ml-0.5"></i>';
                        btn.classList.remove('btn-audio-playing');
                    }
                } else {
                    if (activeAudio) {
                        activeAudio.pause();
                        if (activeAudioBtn) {
                            activeAudioBtn.innerHTML = '<i class="fa-solid fa-play ml-0.5"></i>';
                            activeAudioBtn.classList.remove('btn-audio-playing');
                        }
                    }
                    activeAudio = new Audio(audioUrl);
                    activeAudioBtn = btn;
                    activeAudio.play();
                    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; // Loading state
                    
                    activeAudio.onplaying = () => {
                        btn.innerHTML = '<i class="fa-solid fa-pause"></i>';
                        btn.classList.add('btn-audio-playing');
                    };
                    
                    activeAudio.onended = () => {
                        btn.innerHTML = '<i class="fa-solid fa-play ml-0.5"></i>';
                        btn.classList.remove('btn-audio-playing');
                        activeAudio = null;
                    };
                }
            } else if (action === 'copy') {
                const textToCopy = `${ayat.teksArab}\n\n${ayat.teksIndonesia}\n(QS. ${surahName}: ${ayat.nomorAyat})`;
                copyToClipboard(textToCopy);
            } else if (action === 'share') {
                const textToShare = `${ayat.teksArab}\n\n${ayat.teksIndonesia}\n(QS. ${surahName}: ${ayat.nomorAyat})`;
                if (navigator.share) {
                    navigator.share({
                        title: `QS. ${surahName}: ${ayat.nomorAyat}`,
                        text: textToShare,
                        url: window.location.href
                    }).catch(console.error);
                } else {
                    copyToClipboard(textToShare);
                    showToast("Link disalin (Share tidak didukung browser ini)");
                }
            }
        }

        // ==========================================
        // 7. TAFSIR LOGIC
        // ==========================================
        async function fetchTafsir(surahNo) {
             if (AppState.tafsirCache[surahNo]) return AppState.tafsirCache[surahNo];
             try {
                 const res = await fetch(`https://equran.id/api/v2/tafsir/${surahNo}`);
                 const json = await res.json();
                 if(json.code === 200) {
                     AppState.tafsirCache[surahNo] = json.data.tafsir;
                     return json.data.tafsir;
                 }
                 throw new Error("Gagal mengambil tafsir");
             } catch(e) {
                 return null;
             }
        }

        async function openTafsir(surahNo, ayatNo) {
            openModal('tafsir-modal');
            const titleEl = document.querySelector('#tafsir-modal h3');
            const subEl = document.getElementById('tafsir-subtitle');
            const contentEl = document.getElementById('tafsir-content-area');
            
            // Set initial state
            titleEl.innerHTML = `<i class="fa-solid fa-book-open-reader text-emerald-600 mr-2"></i> Tafsir Ayat ${ayatNo}`;
            subEl.innerText = "Sumber: Kemenag RI";
            contentEl.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-slate-400 gap-2"><i class="fa-solid fa-circle-notch fa-spin text-2xl text-emerald-500"></i><span class="text-xs">Mengambil data tafsir...</span></div>`;

            const tafsirData = await fetchTafsir(surahNo);
            
            if(tafsirData) {
                const ayatTafsir = tafsirData.find(t => t.ayat === ayatNo);
                if(ayatTafsir) {
                    contentEl.innerHTML = `<p>${ayatTafsir.teks}</p>`;
                } else {
                    contentEl.innerHTML = `<p class="text-center text-red-500">Tafsir untuk ayat ini tidak ditemukan.</p>`;
                }
            } else {
                 contentEl.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-slate-400 gap-2"><i class="fa-solid fa-triangle-exclamation text-2xl text-red-500"></i><span class="text-xs text-center">Gagal memuat tafsir.<br>Pastikan koneksi internet lancar.</span><button onclick="openTafsir(${surahNo}, ${ayatNo})" class="mt-2 text-emerald-600 font-bold underline">Coba Lagi</button></div>`;
            }
        }

        // ==========================================
        // 8. LIST/TOC LOGIC (New Feature)
        // ==========================================
        function openTocModal() {
            if (!AppState.data || AppState.data.length === 0) return;
            
            const listContainer = document.getElementById('toc-content-area');
            listContainer.innerHTML = AppState.data.map((item, idx) => {
                const isActive = idx === AppState.currentIndex;
                return `
                <button onclick="jumpToSlide(${idx})" class="w-full text-left p-3 rounded-xl border ${isActive ? 'bg-emerald-50 border-emerald-200 text-emerald-700' : 'bg-white border-gray-100 text-slate-700'} shadow-sm flex items-center gap-3 transition-all active:scale-95">
                    <span class="text-xs font-bold ${isActive ? 'bg-emerald-200 text-emerald-800' : 'bg-slate-100 text-slate-500'} w-6 h-6 rounded flex items-center justify-center shrink-0">${idx + 1}</span>
                    <span class="font-medium text-sm truncate">${item.title || 'Tanpa Judul'}</span>
                    ${isActive ? '<i class="fa-solid fa-circle-check ml-auto text-emerald-600"></i>' : ''}
                </button>`;
            }).join('');
            
            openModal('toc-modal');
        }

        function jumpToSlide(index) {
            AppState.currentIndex = index;
            updateSlidePosition();
            closeAllModals();
        }

        // ==========================================
        // 9. SLIDER VIEW MODIFIED (Switcher + TOC)
        // ==========================================
        function renderSliderView(dataType, title, isRTL, isCombined = false) {
            let data = (dataType === 'favorites') ? getBookmarks() : (DB[dataType] || []);
            AppState.data = data; AppState.currentIndex = 0; AppState.isRTL = isRTL;
            
            if (data.length === 0 && dataType !== 'favorites') { // Simple empty check
                 root.innerHTML = `<div class="h-full flex flex-col items-center justify-center bg-white p-10 text-center"><i class="fa-solid fa-spinner fa-spin text-4xl text-emerald-500 mb-4"></i><h3 class="text-xl font-bold text-slate-800 mb-2">Memuat Data...</h3><button onclick="navigateTo('home')" class="px-6 py-2 bg-slate-200 text-slate-600 rounded-full font-medium text-sm">Kembali</button></div>`; 
                 // Allow retry if data is fetched late
                 setTimeout(() => { if(!DB[dataType]) navigateTo('slider', {type:dataType, title, rtl:isRTL, isCombined}); }, 1000);
                 return;
            } else if (data.length === 0 && dataType === 'favorites') {
                root.innerHTML = `<div class="h-full flex flex-col items-center justify-center bg-white p-10 text-center"><i class="fa-solid fa-heart-crack text-4xl text-slate-300 mb-4"></i><h3 class="text-xl font-bold text-slate-800 mb-2">Data Kosong</h3><button onclick="navigateTo('home')" class="px-6 py-2 bg-emerald-600 text-white rounded-full font-medium">Kembali</button></div>`; return;
            }

            const flexDir = isRTL ? 'flex-row-reverse' : 'flex-row';
            const trackWidth = data.length * 100;
            
            // Switcher HTML logic
            let headerContent = `<h2 class="text-lg font-bold text-slate-800 tracking-tight">${title}</h2>`;
            if (isCombined) {
                const isPagi = dataType === 'dzikirPagi';
                headerContent = `
                    <div class="flex bg-slate-100 p-1 rounded-full border border-slate-200">
                        <button onclick="${isPagi ? '' : "navigateTo('slider', {type:'dzikirPagi', title:'Dzikir Pagi', rtl:true, isCombined:true})"}" class="px-4 py-1.5 rounded-full text-xs font-bold transition-all ${isPagi ? 'bg-white text-emerald-600 shadow-sm border border-gray-100' : 'text-slate-500 hover:text-emerald-600'}">Pagi</button>
                        <button onclick="${!isPagi ? '' : "navigateTo('slider', {type:'dzikirPetang', title:'Dzikir Petang', rtl:true, isCombined:true})"}" class="px-4 py-1.5 rounded-full text-xs font-bold transition-all ${!isPagi ? 'bg-white text-emerald-600 shadow-sm border border-gray-100' : 'text-slate-500 hover:text-emerald-600'}">Petang</button>
                    </div>
                `;
            }

            root.innerHTML = `
                <div class="h-full flex flex-col bg-white animate-fade-in relative">
                    <div class="flex items-center justify-between px-4 py-4 border-b border-gray-100 z-30 bg-white/95 backdrop-blur-sm sticky top-0 h-16">
                        <button onclick="navigateTo('home')" class="w-10 h-10 flex items-center justify-center text-slate-500 hover:bg-slate-100 rounded-full transition-colors"><i class="fa-solid fa-arrow-left"></i></button>
                        ${headerContent}
                        <div class="flex gap-1">
                            <button onclick="openTocModal()" class="w-10 h-10 flex items-center justify-center text-emerald-600 hover:bg-emerald-50 rounded-full transition-colors"><i class="fa-solid fa-list-ul"></i></button>
                            <button onclick="openModal('settings-modal')" class="w-10 h-10 flex items-center justify-center text-emerald-600 hover:bg-emerald-50 rounded-full transition-colors"><i class="fa-solid fa-sliders"></i></button>
                        </div>
                    </div>
                    <div class="flex-grow relative overflow-hidden slider-viewport bg-slate-50">
                        <div id="slides-track" class="h-full flex ${flexDir} items-stretch transition-transform duration-300 ease-out will-change-transform" style="width: ${trackWidth}%; touch-action: pan-y;">
                            ${data.map((item, idx) => SliderCard(item, data.length, idx)).join('')}
                        </div>
                    </div>
                    <div class="px-5 py-2 border-t border-gray-100 bg-white z-30 flex justify-between items-center shadow-[0_-4px_20px_rgba(0,0,0,0.03)] h-20">
                        <button onclick="handleNavClick(${isRTL?1:-1})" class="w-12 h-12 rounded-full bg-slate-50 text-slate-600 hover:bg-slate-200 flex items-center justify-center text-lg"><i class="fa-solid fa-chevron-left"></i></button>
                        <span class="text-xs font-bold text-emerald-600 bg-emerald-50 px-3 py-1 rounded-full"><span id="slide-indicator">1/${data.length}</span></span>
                        <button onclick="handleNavClick(${isRTL?-1:1})" class="w-12 h-12 rounded-full bg-emerald-600 text-white shadow-lg flex items-center justify-center text-lg"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                </div>`;
            initSwipeLogic(); updateSlidePosition(); 
        }

        function SliderCard(item, total, index) {
            const w = 100/total;
            const cnt = parseInt(item.count || 1);
            const isFav = isBookmarked(item);
            return `<div class="h-full flex-shrink-0 overflow-y-auto hide-scrollbar flex flex-col items-center relative" style="width: ${w}%">
                <button id="btn-heart-${index}" onclick="toggleBookmark(${index})" class="absolute top-4 right-4 z-20 w-10 h-10 flex items-center justify-center bg-white/80 rounded-full shadow-sm ${isFav?"text-rose-500":"text-slate-300"} text-xl active:scale-90 transition-all border border-gray-100"><i class="fa-solid fa-heart"></i></button>
                <div class="w-full min-h-full flex flex-col items-center py-6 px-4 md:px-8">
                    <div class="my-auto w-full flex flex-col items-center max-w-md">
                        ${cnt > 1 ? `<button onclick="handleTasbihTap(this, ${cnt})" data-current="0" class="group relative inline-flex items-center justify-center bg-emerald-50 text-emerald-700 font-bold text-sm px-6 py-2.5 rounded-full mb-4 shadow-sm border border-emerald-200"><i class="fa-solid fa-fingerprint mr-2"></i> <span class="tasbih-counter">0</span> / ${cnt}</button>` : `<div class="inline-flex items-center justify-center bg-emerald-50 text-emerald-700 font-bold text-[10px] uppercase tracking-wide px-3 py-1.5 rounded-full mb-4 shadow-sm border border-emerald-100">Baca 1x</div>`}
                        <h3 class="text-emerald-700 font-bold text-lg mb-6 text-center leading-tight">${item.title||""}</h3>
                        <div class="w-full mb-8 text-center" dir="rtl"><p class="font-arabic-dynamic text-black leading-[2.2] select-text">${item.arabic||""}</p></div>
                        <div class="w-full text-center pb-4 space-y-4">
                            ${item.latin?`<p class="text-emerald-700 text-sm font-medium italic opacity-90 px-2">${item.latin}</p>`:""}
                            <p class="font-translation-dynamic text-slate-600 font-normal leading-relaxed">${item.translation||""}</p>
                            ${item.faedah?`<div class="mt-6 mx-4 p-4 bg-amber-50 rounded-xl text-[13px] text-amber-900 border border-amber-100 shadow-sm text-left"><strong class="block text-amber-700 mb-1.5 text-[10px] uppercase tracking-wider font-bold"><i class="fa-solid fa-circle-info mr-1"></i> Referensi</strong>${item.faedah}</div>`:""}
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function updateSlidePosition() {
            const track = document.getElementById('slides-track'); if(!track) return;
            const idx = AppState.currentIndex, len = AppState.data.length, step = 100/len;
            track.style.transform = `translateX(${AppState.isRTL ? - (len - 1 - idx) * step : -(idx * step)}%)`;
            document.getElementById('slide-indicator').innerText = `${idx+1}/${len}`;
        }
        window.handleNavClick = function(dir) { let n = AppState.currentIndex + dir; if(n >= 0 && n < AppState.data.length) { AppState.currentIndex = n; updateSlidePosition(); } }
        function initSwipeLogic() {
            const wrap = document.querySelector('.slider-viewport'); if(!wrap) return;
            let sx = 0; wrap.addEventListener('touchstart', e => { sx = e.touches[0].clientX; }, {passive: true});
            wrap.addEventListener('touchend', e => { let diff = sx - e.changedTouches[0].clientX; if(Math.abs(diff)>50) handleNavClick(AppState.isRTL ? (diff<0?1:-1) : (diff>0?1:-1)); });
        }
        document.addEventListener('DOMContentLoaded', () => { initSettings(); fetchData(); renderHome(); });
    </script>
</body>
</html>
